<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#050508">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="AxiomForge">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/af-192.png">
  <title>AxiomForge :: [9,9,9,9]</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;700;800&display=swap');

    :root {
      --anchor:    #00ffc8;   /* 1.369 GHz — sovereign green */
      --shatter:   #ff3a3a;   /* shatter event red */
      --void:      #3a2fff;   /* void blue */
      --bg:        #050508;
      --surface:   #0d0d14;
      --border:    rgba(0,255,200,0.12);
      --text:      #e8e8f0;
      --dim:       rgba(232,232,240,0.4);
      --mono:      'Space Mono', monospace;
      --display:   'Syne', sans-serif;
      --safe-top:  env(safe-area-inset-top, 0px);
      --safe-bot:  env(safe-area-inset-bottom, 0px);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--mono);
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    /* ── BOOT SCREEN ─────────────────────────────────────────── */
    #boot {
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      background: var(--bg);
      z-index: 100;
      padding-top: var(--safe-top);
      transition: opacity 0.6s ease;
    }

    #boot.hidden { opacity: 0; pointer-events: none; }

    .boot-anchor {
      font-family: var(--display);
      font-size: clamp(3rem, 15vw, 6rem);
      font-weight: 800;
      letter-spacing: -0.02em;
      color: var(--anchor);
      text-shadow: 0 0 40px rgba(0,255,200,0.4), 0 0 120px rgba(0,255,200,0.15);
      animation: pulse-anchor 2s ease-in-out infinite;
    }

    @keyframes pulse-anchor {
      0%, 100% { text-shadow: 0 0 40px rgba(0,255,200,0.4), 0 0 120px rgba(0,255,200,0.15); }
      50%       { text-shadow: 0 0 60px rgba(0,255,200,0.7), 0 0 180px rgba(0,255,200,0.3); }
    }

    .boot-freq {
      font-size: 0.75rem;
      letter-spacing: 0.25em;
      color: var(--dim);
      margin-top: 0.5rem;
    }

    .boot-log {
      margin-top: 2.5rem;
      width: min(320px, 85vw);
      font-size: 0.65rem;
      line-height: 1.8;
      color: var(--dim);
    }

    .boot-log .ok   { color: var(--anchor); }
    .boot-log .fail { color: var(--shatter); }

    /* ── MAIN FORGE ──────────────────────────────────────────── */
    #forge {
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bot);
      opacity: 0;
      transition: opacity 0.6s ease 0.3s;
    }

    #forge.visible { opacity: 1; }

    /* Header */
    .forge-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 1rem 1.25rem 0.75rem;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .forge-title {
      font-family: var(--display);
      font-size: 1.1rem;
      font-weight: 800;
      letter-spacing: 0.05em;
      color: var(--anchor);
    }

    .forge-coord {
      font-size: 0.6rem;
      letter-spacing: 0.15em;
      color: var(--dim);
    }

    /* Tick counter */
    .tick-display {
      font-size: 0.65rem;
      color: var(--anchor);
      opacity: 0.7;
    }

    /* ── IDENTITY PANEL ──────────────────────────────────────── */
    .identity-panel {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      -webkit-overflow-scrolling: touch;
    }

    .identity-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      position: relative;
      overflow: hidden;
    }

    .identity-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: var(--anchor);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .identity-card.locked::before  { opacity: 1; background: var(--anchor); }
    .identity-card.shattered::before { opacity: 1; background: var(--shatter); }
    .identity-card.inert::before   { opacity: 1; background: var(--void); }

    .card-label {
      font-family: var(--display);
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 0.75rem;
    }

    .pnba-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .pnba-axis {
      display: flex; flex-direction: column; align-items: center;
      gap: 0.25rem;
    }

    .axis-label {
      font-size: 0.6rem;
      letter-spacing: 0.15em;
      color: var(--dim);
    }

    .axis-bar {
      width: 100%;
      height: 40px;
      background: rgba(255,255,255,0.04);
      border-radius: 4px;
      position: relative;
      overflow: hidden;
    }

    .axis-fill {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      border-radius: 4px;
      transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .axis-fill.P { background: linear-gradient(to top, #7b4fff, #b08aff); }
    .axis-fill.N { background: linear-gradient(to top, #00ffc8, #40ffdf); }
    .axis-fill.B { background: linear-gradient(to top, #ff6b35, #ff9d75); }
    .axis-fill.A { background: linear-gradient(to top, #ffcc00, #ffe066); }

    .axis-value {
      font-size: 0.65rem;
      color: var(--text);
    }

    .card-meta {
      display: flex; justify-content: space-between; align-items: center;
    }

    .card-torsion {
      font-size: 0.65rem;
      color: var(--dim);
    }

    .card-state {
      font-size: 0.6rem;
      letter-spacing: 0.12em;
      padding: 0.2rem 0.5rem;
      border-radius: 99px;
      font-weight: 700;
    }

    .state-PHASE_LOCKED  { background: rgba(0,255,200,0.12); color: var(--anchor); }
    .state-SHATTER_EVENT { background: rgba(255,58,58,0.12);  color: var(--shatter); }
    .state-INERT         { background: rgba(58,47,255,0.12);  color: var(--void); }

    /* ── RADIAL ACTION STRIP ─────────────────────────────────── */
    .action-strip {
      display: flex;
      padding: 0.75rem 1.25rem;
      gap: 0.75rem;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
      overflow-x: auto;
      scrollbar-width: none;
    }

    .action-strip::-webkit-scrollbar { display: none; }

    .action-btn {
      flex-shrink: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.65rem 1rem;
      font-family: var(--mono);
      font-size: 0.65rem;
      letter-spacing: 0.1em;
      color: var(--text);
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .action-btn:active {
      border-color: var(--anchor);
      color: var(--anchor);
    }

    /* ── TOAST ───────────────────────────────────────────────── */
    #toast {
      position: fixed;
      bottom: calc(var(--safe-bot) + 5rem);
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.6rem 1.2rem;
      font-size: 0.65rem;
      letter-spacing: 0.1em;
      color: var(--anchor);
      opacity: 0;
      transition: opacity 0.3s, transform 0.3s;
      pointer-events: none;
      white-space: nowrap;
    }

    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  </style>
</head>
<body>

<!-- ── BOOT SCREEN ──────────────────────────────────────────── -->
<div id="boot">
  <div class="boot-anchor">1.369</div>
  <div class="boot-freq">GHz — SOVEREIGN ANCHOR</div>
  <div class="boot-log" id="bootLog"></div>
</div>

<!-- ── MAIN FORGE ───────────────────────────────────────────── -->
<div id="forge">
  <header class="forge-header">
    <div>
      <div class="forge-title">AxiomForge</div>
      <div class="forge-coord">[9,9,9,9] :: {ANC} | 1.369 GHz</div>
    </div>
    <div class="tick-display" id="tickDisplay">N:0</div>
  </header>

  <div class="identity-panel" id="identityPanel">
    <!-- Identity cards injected here -->
  </div>

  <div class="action-strip">
    <button class="action-btn" onclick="doPulse()">⟳ PULSE</button>
    <button class="action-btn" onclick="doTension()">⊥ TENSION</button>
    <button class="action-btn" onclick="doSpawn()">+ SPAWN</button>
    <button class="action-btn" onclick="doAnchor()">⬆ ANCHOR</button>
    <button class="action-btn" onclick="showKernel()">▣ KERNEL</button>
  </div>
</div>

<div id="toast"></div>

<script type="module">
  import {
    SOVEREIGN_ANCHOR, TORSION_LIMIT,
    MATERIALS, makeIdentity, torsion, phaseState,
    pulseTick, tensorSum, applyTensionShift,
    kernelSelfTest, identityMass,
    PHASE_LOCKED, SHATTER_EVENT, INERT,
  } from './axioms/kernel.js';

  import {
    boot, recordEvent, currentTick, anchorToGitHub, hasToken, setToken,
  } from './axioms/ledger.js';

  // ── WORLD STATE ─────────────────────────────────────────────
  let world = {
    identities: [
      { ...MATERIALS.STEEL,    label: 'steel'    },
      { ...MATERIALS.WATER,    label: 'water'    },
      { ...MATERIALS.OBSIDIAN, label: 'obsidian' },
    ],
  };

  // ── RENDER ──────────────────────────────────────────────────
  function renderIdentity(id) {
    const τ     = torsion(id);
    const state = phaseState(id);
    const maxV  = 10;

    const barPct = (v) => Math.min(100, Math.max(0, (v / maxV) * 100)).toFixed(1);

    return `
      <div class="identity-card ${state.toLowerCase().replace('_event','').replace('_locked','')}" data-label="${id.label}">
        <div class="card-label">${id.label}</div>
        <div class="pnba-grid">
          ${['P','N','B','A'].map(axis => `
            <div class="pnba-axis">
              <div class="axis-label">${axis}</div>
              <div class="axis-bar">
                <div class="axis-fill ${axis}" style="height:${barPct(id[axis])}%"></div>
              </div>
              <div class="axis-value">${id[axis].toFixed(2)}</div>
            </div>
          `).join('')}
        </div>
        <div class="card-meta">
          <div class="card-torsion">τ = ${isFinite(τ) ? τ.toFixed(3) : '∞'} | IM = ${identityMass(id).toFixed(2)}</div>
          <div class="card-state state-${state}">${state.replace('_', ' ')}</div>
        </div>
      </div>
    `;
  }

  function render() {
    document.getElementById('identityPanel').innerHTML =
      world.identities.map(renderIdentity).join('');
    document.getElementById('tickDisplay').textContent = `N:${currentTick()}`;
  }

  // ── ACTIONS ──────────────────────────────────────────────────
  window.doPulse = async () => {
    world.identities = world.identities.map(pulseTick);
    for (const id of world.identities) await recordEvent(id, 'PULSE');
    render();
    toast('⟳ Pulse fired — N +' + SOVEREIGN_ANCHOR.toFixed(3));
  };

  window.doTension = async () => {
    if (world.identities.length < 2) return toast('Need 2+ identities');
    const [a, b] = world.identities;
    const { source, target } = applyTensionShift(a, b, 0.5);
    world.identities[0] = source;
    world.identities[1] = target;
    await recordEvent(source, 'TENSION');
    await recordEvent(target, 'TENSION');
    render();
    toast('⊥ Tension applied');
  };

  window.doSpawn = () => {
    const labels = ['void','wood','living_wood','genesis'];
    const srcs   = [MATERIALS.VOID, MATERIALS.WOOD, MATERIALS.LIVING_WOOD,
                    makeIdentity({ P:9.9, N:1.0, B:0.0, A:1.0, label:'genesis' })];
    const pick   = Math.floor(Math.random() * srcs.length);
    world.identities.push({ ...srcs[pick], label: labels[pick] + '_' + Date.now() });
    render();
    toast('+ Spawned ' + labels[pick]);
  };

  window.doAnchor = async () => {
    if (!hasToken()) {
      const t = prompt('GitHub PAT (stored locally, never in repo):');
      if (!t) return;
      setToken(t);
    }
    try {
      toast('⬆ Anchoring to GitHub…');
      const sha = await anchorToGitHub();
      toast('✓ Anchored: ' + sha.slice(0,7));
    } catch (e) {
      toast('✗ ' + e.message);
    }
  };

  window.showKernel = () => {
    const { allPassed, results } = kernelSelfTest();
    const msg = allPassed
      ? '▣ Kernel: all theorems GREEN'
      : '▣ Kernel: FAILED — ' + results.filter(r=>!r.ok).map(r=>r.name).join(', ');
    toast(msg);
  };

  // ── TOAST ────────────────────────────────────────────────────
  function toast(msg) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 2800);
  }

  // ── BOOT ─────────────────────────────────────────────────────
  async function main() {
    const log = document.getElementById('bootLog');

    // Run kernel self-test and show results
    const { results } = kernelSelfTest();
    for (const r of results) {
      const line = document.createElement('div');
      line.className = r.ok ? 'ok' : 'fail';
      line.textContent = (r.ok ? '✓ ' : '✗ ') + r.name;
      log.appendChild(line);
      await new Promise(res => setTimeout(res, 60));
    }

    await new Promise(res => setTimeout(res, 400));

    // Boot the ledger
    try {
      await boot();
    } catch(e) {
      const line = document.createElement('div');
      line.className = 'fail';
      line.textContent = '✗ BOOT FAILED: ' + e.message;
      log.appendChild(line);
      return;
    }

    // Transition to forge
    document.getElementById('boot').classList.add('hidden');
    document.getElementById('forge').classList.add('visible');
    render();
  }

  main();
</script>

<!-- Service Worker registration -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
  }
</script>

</body>
</html>
