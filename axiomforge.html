<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#050508">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="AxiomForge">
  <link rel="manifest" href="manifest.json">
  <title>AxiomForge :: [9,9,9,9]</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@700;800&display=swap');
    :root {
      --anchor:#00ffc8;--shatter:#ff3a3a;--void:#3a2fff;
      --bg:#050508;--surface:#0d0d14;--border:rgba(0,255,200,0.12);
      --text:#e8e8f0;--dim:rgba(232,232,240,0.4);
      --safe-top:env(safe-area-inset-top,0px);--safe-bot:env(safe-area-inset-bottom,0px);
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Space Mono',monospace;overflow:hidden;-webkit-tap-highlight-color:transparent;user-select:none}

    /* VIEWPORT (BLENDER STAGE) */
    #viewportCanvas {
      position: fixed; top: 0; left: 0; width: 100%; height: 50%;
      background: #000; z-index: 1; border-bottom: 1px solid var(--border);
    }

    /* BOOT */
    #boot{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);z-index:100;padding-top:var(--safe-top);transition:opacity .5s ease}
    #boot.fade{opacity:0;pointer-events:none}
    .boot-num{font-family:'Syne',sans-serif;font-size:clamp(4rem,20vw,7rem);font-weight:800;color:var(--anchor);text-shadow:0 0 40px rgba(0,255,200,.5),0 0 120px rgba(0,255,200,.2);animation:glow 2.5s ease-in-out infinite}
    @keyframes glow{0%,100%{text-shadow:0 0 40px rgba(0,255,200,.5),0 0 120px rgba(0,255,200,.2)}50%{text-shadow:0 0 70px rgba(0,255,200,.9),0 0 200px rgba(0,255,200,.4)}}
    .boot-sub{font-size:.65rem;letter-spacing:.3em;color:var(--dim);margin-top:.5rem}
    #bootLog{margin-top:2rem;width:min(300px,82vw);font-size:.6rem;line-height:2.2}
    #bootLog .ok{color:var(--anchor)}
    #bootLog .fail{color:var(--shatter)}

    /* FORGE */
    #forge{position:fixed;inset:0;display:flex;flex-direction:column;padding-top:var(--safe-top);padding-bottom:var(--safe-bot);opacity:0;pointer-events:none;transition:opacity .5s ease .2s; z-index: 2;}
    #forge.visible{opacity:1;pointer-events:all}
    .hdr{display:flex;align-items:center;justify-content:space-between;padding:1rem 1.25rem .75rem;border-bottom:1px solid var(--border);flex-shrink:0; background: rgba(5,5,8,0.8); backdrop-filter: blur(10px);}
    .hdr-title{font-family:'Syne',sans-serif;font-weight:800;font-size:1.05rem;color:var(--anchor)}
    .hdr-coord{font-size:.55rem;letter-spacing:.12em;color:var(--dim);margin-top:.15rem}
    .hdr-tick{font-size:.6rem;color:var(--anchor);opacity:.7}
    
    .panel{flex:1; overflow-y:auto; padding:.9rem 1rem; display:flex; flex-direction:column; gap:.85rem; -webkit-overflow-scrolling:touch; margin-top: 40vh;}
    
    .card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:.9rem;position:relative;overflow:hidden; transition: transform 0.2s;}
    .card.active{border-color: var(--anchor); transform: scale(1.02);}
    .card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;opacity:0;transition:opacity .3s}
    .card.locked::before{opacity:1;background:var(--anchor)}
    .card.shattered::before{opacity:1;background:var(--shatter)}
    .card-name{font-family:'Syne',sans-serif;font-weight:700;font-size:.8rem;letter-spacing:.08em;text-transform:uppercase;margin-bottom:.7rem}
    .pnba-row{display:grid;grid-template-columns:repeat(4,1fr);gap:.4rem;margin-bottom:.65rem}
    .ax{display:flex;flex-direction:column;align-items:center;gap:.2rem}
    .ax-lbl{font-size:.55rem;letter-spacing:.15em;color:var(--dim)}
    .ax-bar{width:100%;height:36px;background:rgba(255,255,255,.04);border-radius:4px;position:relative;overflow:hidden}
    .ax-fill{position:absolute;bottom:0;left:0;right:0;border-radius:4px;transition:height .35s cubic-bezier(.4,0,.2,1)}
    .ax-fill.P{background:linear-gradient(to top,#7b4fff,#b08aff)}
    .ax-fill.N{background:linear-gradient(to top,#00ffc8,#40ffdf)}
    .ax-fill.B{background:linear-gradient(to top,#ff6b35,#ff9d75)}
    .ax-fill.A{background:linear-gradient(to top,#ffcc00,#ffe066)}
    .ax-val{font-size:.6rem}
    .card-foot{display:flex;justify-content:space-between;align-items:center}
    .card-tau{font-size:.6rem;color:var(--dim)}
    .badge{font-size:.55rem;letter-spacing:.1em;padding:.18rem .45rem;border-radius:99px;font-weight:700}
    .badge.PHASE_LOCKED{background:rgba(0,255,200,.1);color:var(--anchor)}
    .badge.SHATTER_EVENT{background:rgba(255,58,58,.1);color:var(--shatter)}
    
    .strip{display:flex;padding:.65rem 1rem;gap:.6rem;border-top:1px solid var(--border);flex-shrink:0;overflow-x:auto;scrollbar-width:none; background: var(--bg);}
    .btn{flex-shrink:0;background:var(--surface);border:1px solid var(--border);border-radius:9px;padding:.6rem .9rem;font-family:'Space Mono',monospace;font-size:.6rem;letter-spacing:.1em;color:var(--text);cursor:pointer;}
    .btn:active{border-color:var(--anchor);color:var(--anchor)}
    #toast{position:fixed;bottom:calc(var(--safe-bot) + 5.5rem);left:50%;transform:translateX(-50%) translateY(16px);background:var(--surface);border:1px solid var(--border);border-radius:9px;padding:.5rem 1.1rem;font-size:.6rem;letter-spacing:.08em;color:var(--anchor);opacity:0;transition:opacity .25s,transform .25s;pointer-events:none;z-index:200}
    #toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
  </style>
</head>
<body>

<canvas id="viewportCanvas"></canvas>

<div id="boot">
  <div class="boot-num">1.369</div>
  <div class="boot-sub">GHz — SOVEREIGN ANCHOR</div>
  <div id="bootLog"></div>
</div>

<div id="forge">
  <div class="hdr">
    <div>
      <div class="hdr-title">AxiomForge</div>
      <div class="hdr-coord">[9,9,9,9] :: {ANC} | 1.369 GHz</div>
    </div>
    <div class="hdr-tick" id="tickDisplay">N:0</div>
  </div>
  
  <div class="panel" id="panel"></div>

  <div class="strip">
    <button class="btn" id="btnPulse">⟳ PULSE</button>
    <button class="btn" id="btnTension">⊥ TENSION</button>
    <button class="btn" id="btnSpawn">+ SPAWN</button>
    <button class="btn" id="btnAnchor">⬆ ANCHOR</button>
    <button class="btn" id="btnKernel">▣ KERNEL</button>
  </div>
</div>

<div id="toast"></div>

<script type="module">
import { AxiomViewport } from './src/axiomforge.viewport.js';
import { AxiomSculptor } from './src/axiomforge.sculpt.js';

// [P] KERNEL
const SOVEREIGN_ANCHOR=1.369,TORSION_LIMIT=.2,PHASE_LOCKED='PHASE_LOCKED',SHATTER_EVENT='SHATTER_EVENT';

const mkId = (P,N,B,A,label) => ({P,N,B,A,label});
const im = (id) => (id.P+id.N+id.B+id.A)*SOVEREIGN_ANCHOR;
const tau = (id) => id.P<=0?Infinity:id.B/id.P;
const state = (id) => tau(id)<TORSION_LIMIT?PHASE_LOCKED:SHATTER_EVENT;

let world = [
  mkId(8, 9.11, 1.2, 5, 'steel'),
  mkId(1, 7.11, 0.1, 3, 'water'),
  mkId(9, 4.21, 0.5, 0.1, 'obsidian')
];

// Initialize Blender-Style Engines
const viewport = new AxiomViewport('viewportCanvas');
const sculptor = new AxiomSculptor(document.getElementById('panel'), world);

// [B] UI RENDERER
function render() {
  const panel = document.getElementById('panel');
  panel.innerHTML = world.map((id, index) => {
    const τ = tau(id);
    const st = state(id);
    const activeClass = sculptor.activeId === id ? 'active' : '';
    
    return `
      <div class="card ${st==PHASE_LOCKED?'locked':'shattered'} ${activeClass}" onclick="selectId(${index})">
        <div class="card-name">${id.label}</div>
        <div class="pnba-row">
          ${['P','N','B','A'].map(ax => `
            <div class="ax">
              <div class="ax-lbl">${ax}</div>
              <div class="ax-bar"><div class="ax-fill ${ax}" style="height:${Math.min(100,(id[ax]/10)*100)}%"></div></div>
              <div class="ax-val">${id[ax].toFixed(2)}</div>
            </div>
          `).join('')}
        </div>
        <div class="card-foot">
          <div class="card-tau">τ=${τ.toFixed(3)} IM=${im(id).toFixed(2)}</div>
          <div class="badge ${st}">${st.replace('_',' ')}</div>
        </div>
      </div>
    `;
  }).join('');
  viewport.updateState(world);
}

window.selectId = (i) => {
  sculptor.selectIdentity(world[i]);
  render();
};

// ACTIONS
document.getElementById('btnPulse').onclick = () => {
  world = world.map(id => mkId(id.P, id.N+SOVEREIGN_ANCHOR, id.B, id.A, id.label));
  render();
  toast('⟳ Pulse Fired');
};

document.getElementById('btnSpawn').onclick = () => {
  world.push(mkId(5, 1, 0.5, 1, 'new_atom_'+Date.now().toString().slice(-4)));
  render();
};

function toast(msg){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2000)}

// BOOT SEQUENCE
(async function() {
  const log = document.getElementById('bootLog');
  const steps = ['Initializing 1.369 GHz Anchor...', 'Loading pNBA Kernel...', 'Manifesting Viewport...', 'Ready.'];
  for (let s of steps) {
    const d = document.createElement('div'); d.className='ok'; d.textContent='✓ ' + s;
    log.appendChild(d); await new Promise(r => setTimeout(r, 400));
  }
  document.getElementById('boot').classList.add('fade');
  document.getElementById('forge').classList.add('visible');
  render();
})();
</script>
</body>
</html>
